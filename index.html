<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="wechat-mobile-web-app-capable" content="yes">
  <title>光伏板数量计算器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  
  <!-- 配置Tailwind自定义主题 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            neutral: '#F5F7FA',
            dark: '#1D2129',
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .shadow-soft {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }
      .panel-grid {
        background-size: 24px 13px;
        background-image: 
          linear-gradient(to right, rgba(22, 93, 255, 0.1) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(22, 93, 255, 0.1) 1px, transparent 1px);
      }
      .visualization-container {
        height: 180px; /* 固定可视化容器高度，确保首次加载能正确获取尺寸 */
        position: relative;
        overflow: auto;
      }
    }
  </style>
</head>
<body class="font-inter bg-neutral min-h-screen">
  <!-- 顶部导航 -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-sun-o text-primary text-2xl"></i>
        <h1 class="text-xl md:text-2xl font-bold text-dark">光伏板数量计算器</h1>
      </div>
      <div class="text-sm text-gray-500">
        光伏板规格: 2.4m × 1.3m
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <!-- 输入区域 -->
    <section class="bg-white rounded-xl shadow-soft p-6 mb-8 transform transition-all duration-300 hover:shadow-lg">
      <h2 class="text-lg font-semibold mb-4 text-dark">请输入安装区域尺寸 (单位: 米)</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label for="length" class="block text-sm font-medium text-gray-700 mb-1">区域长度</label>
          <div class="relative">
            <input type="number" id="length" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                  placeholder="例如: 10" min="0" step="0.1">
            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">m</span>
          </div>
        </div>
        <div>
          <label for="width" class="block text-sm font-medium text-gray-700 mb-1">区域宽度</label>
          <div class="relative">
            <input type="number" id="width" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none"
                  placeholder="例如: 8" min="0" step="0.1">
            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">m</span>
          </div>
        </div>
      </div>
      
      <div class="mt-6 flex justify-center">
        <button id="calculateBtn" 
                class="bg-primary hover:bg-primary/90 text-white font-medium px-6 py-3 rounded-lg transition-all transform hover:scale-105 active:scale-95 flex items-center space-x-2 shadow-md">
          <i class="fa fa-calculator"></i>
          <span>计算最优方案</span>
        </button>
      </div>
    </section>
    
    <!-- 结果展示区域 -->
    <section id="resultSection" class="hidden">
      <!-- 最优结果摘要 -->
      <div class="bg-white rounded-xl shadow-soft p-6 mb-8">
        <h2 class="text-lg font-semibold mb-4 text-dark">最优方案</h2>
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="text-center md:text-left mb-4 md:mb-0">
            <p class="text-gray-500 mb-1">最佳排列方式</p>
            <p id="bestMethod" class="text-xl font-bold text-primary"></p>
          </div>
          <div class="text-center mb-4 md:mb-0">
            <p class="text-gray-500 mb-1">最多可放置数量</p>
            <p id="maxPanels" class="text-3xl font-bold text-dark"></p>
          </div>
          <div class="text-center md:text-right">
            <p class="text-gray-500 mb-1">空间利用率</p>
            <p id="utilization" class="text-xl font-bold text-secondary"></p>
          </div>
        </div>
      </div>
      
      <!-- 三种方案对比 -->
      <div class="grid md:grid-cols-3 gap-6 mb-8">
        <!-- 横排方案 -->
        <div class="bg-white rounded-xl shadow-soft p-5 transform transition-all duration-300 hover:shadow-lg">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold text-dark">横排方案</h3>
            <span class="bg-primary/10 text-primary text-xs px-2 py-1 rounded-full">2.4m × 1.3m</span>
          </div>
          <div class="mb-4">
            <p class="text-sm text-gray-500 mb-1">可放置数量</p>
            <p id="horizontalCount" class="text-2xl font-bold text-dark"></p>
          </div>
          <div class="panel-grid visualization-container mb-3">
            <div id="horizontalVisualization" class="absolute inset-0">
              <!-- 动态生成的光伏板可视化 -->
            </div>
          </div>
          <div class="text-xs text-gray-500">
            <p>每行放置: <span id="horizontalPerRow"></span> 块</p>
            <p>共放置: <span id="horizontalRows"></span> 行</p>
          </div>
        </div>
        
        <!-- 竖排方案 -->
        <div class="bg-white rounded-xl shadow-soft p-5 transform transition-all duration-300 hover:shadow-lg">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold text-dark">竖排方案</h3>
            <span class="bg-primary/10 text-primary text-xs px-2 py-1 rounded-full">1.3m × 2.4m</span>
          </div>
          <div class="mb-4">
            <p class="text-sm text-gray-500 mb-1">可放置数量</p>
            <p id="verticalCount" class="text-2xl font-bold text-dark"></p>
          </div>
          <div class="panel-grid visualization-container mb-3">
            <div id="verticalVisualization" class="absolute inset-0">
              <!-- 动态生成的光伏板可视化 -->
            </div>
          </div>
          <div class="text-xs text-gray-500">
            <p>每行放置: <span id="verticalPerRow"></span> 块</p>
            <p>共放置: <span id="verticalRows"></span> 行</p>
          </div>
        </div>
        
        <!-- 混合方案 -->
        <div class="bg-white rounded-xl shadow-soft p-5 transform transition-all duration-300 hover:shadow-lg">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-semibold text-dark">混合方案</h3>
            <span class="bg-secondary/10 text-secondary text-xs px-2 py-1 rounded-full">组合排列</span>
          </div>
          <div class="mb-4">
            <p class="text-sm text-gray-500 mb-1">可放置数量</p>
            <p id="hybridCount" class="text-2xl font-bold text-dark"></p>
          </div>
          <div class="panel-grid visualization-container mb-3">
            <div id="hybridVisualization" class="absolute inset-0">
              <!-- 动态生成的光伏板可视化 -->
            </div>
          </div>
          <div class="text-xs text-gray-500">
            <p>横排: <span id="hybridHorizontal"></span> 块</p>
            <p>竖排: <span id="hybridVertical"></span> 块</p>
          </div>
        </div>
      </div>
      
      <!-- 数据对比图表 -->
      <div class="bg-white rounded-xl shadow-soft p-6">
        <h2 class="text-lg font-semibold mb-4 text-dark">方案对比</h2>
        <div class="h-64">
          <canvas id="comparisonChart"></canvas>
        </div>
      </div>
    </section>
    
    <!-- 输入提示 -->
    <section id="emptyState" class="py-16 text-center">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 text-primary mb-4">
        <i class="fa fa-pencil text-2xl"></i>
      </div>
      <h2 class="text-xl font-semibold text-dark mb-2">请输入安装区域尺寸</h2>
      <p class="text-gray-500 max-w-md mx-auto">输入区域的长度和宽度，系统将自动计算横排、竖排和混合排列三种方式下，能放置的2.4×1.3规格光伏板的最大数量</p>
    </section>
  </main>

  <footer class="bg-white border-t mt-12 py-6">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
      <p>© 2023 光伏板数量计算器 | 光伏板规格固定为 2.4m × 1.3m</p>
    </div>
  </footer>

  <script>
    // 光伏板尺寸 (米)
    const PANEL_LENGTH = 2.4;
    const PANEL_WIDTH = 1.3;
    
    // DOM元素
    const lengthInput = document.getElementById('length');
    const widthInput = document.getElementById('width');
    const calculateBtn = document.getElementById('calculateBtn');
    const resultSection = document.getElementById('resultSection');
    const emptyState = document.getElementById('emptyState');
    
    // 结果元素
    const bestMethodEl = document.getElementById('bestMethod');
    const maxPanelsEl = document.getElementById('maxPanels');
    const utilizationEl = document.getElementById('utilization');
    
    // 横排方案元素
    const horizontalCountEl = document.getElementById('horizontalCount');
    const horizontalPerRowEl = document.getElementById('horizontalPerRow');
    const horizontalRowsEl = document.getElementById('horizontalRows');
    const horizontalVisualization = document.getElementById('horizontalVisualization');
    
    // 竖排方案元素
    const verticalCountEl = document.getElementById('verticalCount');
    const verticalPerRowEl = document.getElementById('verticalPerRow');
    const verticalRowsEl = document.getElementById('verticalRows');
    const verticalVisualization = document.getElementById('verticalVisualization');
    
    // 混合方案元素
    const hybridCountEl = document.getElementById('hybridCount');
    const hybridHorizontalEl = document.getElementById('hybridHorizontal');
    const hybridVerticalEl = document.getElementById('hybridVertical');
    const hybridVisualization = document.getElementById('hybridVisualization');
    
    // 图表实例
    let comparisonChart = null;
    
    // 计算横排方案
    function calculateHorizontal(areaLength, areaWidth) {
      // 横向放置: 光伏板长2.4m 宽1.3m
      const panelsPerRow = Math.floor(areaLength / PANEL_LENGTH);
      const rows = Math.floor(areaWidth / PANEL_WIDTH);
      const total = panelsPerRow * rows;
      
      return {
        type: 'horizontal',
        panelsPerRow,
        rows,
        total,
        panelWidth: PANEL_WIDTH,
        panelLength: PANEL_LENGTH
      };
    }
    
    // 计算竖排方案
    function calculateVertical(areaLength, areaWidth) {
      // 竖向放置: 光伏板长1.3m 宽2.4m (旋转90度)
      const panelsPerRow = Math.floor(areaLength / PANEL_WIDTH);
      const rows = Math.floor(areaWidth / PANEL_LENGTH);
      const total = panelsPerRow * rows;
      
      return {
        type: 'vertical',
        panelsPerRow,
        rows,
        total,
        panelWidth: PANEL_LENGTH,
        panelLength: PANEL_WIDTH
      };
    }
    
    // 计算混合方案 - 尝试不同的排列组合找到最优解
    function calculateHybrid(areaLength, areaWidth) {
      let maxTotal = 0;
      let bestCombination = {
        horizontal: 0,
        vertical: 0,
        horizontalConfig: null,
        verticalConfig: null
      };
      
      // 尝试不同的横向和竖向组合
      // 先横向放几行，剩下的空间放竖向
      for (let hRows = 0; hRows <= Math.floor(areaWidth / PANEL_WIDTH); hRows++) {
        const remainingWidth = areaWidth - hRows * PANEL_WIDTH;
        if (remainingWidth < PANEL_LENGTH) continue;
        
        // 横向放置的数量
        const horizontal = hRows * Math.floor(areaLength / PANEL_LENGTH);
        
        // 剩余空间竖向放置的数量
        const verticalPerRow = Math.floor(areaLength / PANEL_WIDTH);
        const vRows = Math.floor(remainingWidth / PANEL_LENGTH);
        const vertical = verticalPerRow * vRows;
        
        const total = horizontal + vertical;
        
        if (total > maxTotal) {
          maxTotal = total;
          bestCombination = {
            horizontal,
            vertical,
            horizontalConfig: { panelsPerRow: Math.floor(areaLength / PANEL_LENGTH), rows: hRows },
            verticalConfig: { panelsPerRow: verticalPerRow, rows: vRows }
          };
        }
      }
      
      // 先竖向放几行，剩下的空间放横向
      for (let vRows = 0; vRows <= Math.floor(areaWidth / PANEL_LENGTH); vRows++) {
        const remainingWidth = areaWidth - vRows * PANEL_LENGTH;
        if (remainingWidth < PANEL_WIDTH) continue;
        
        // 竖向放置的数量
        const vertical = vRows * Math.floor(areaLength / PANEL_WIDTH);
        
        // 剩余空间横向放置的数量
        const horizontalPerRow = Math.floor(areaLength / PANEL_LENGTH);
        const hRows = Math.floor(remainingWidth / PANEL_WIDTH);
        const horizontal = horizontalPerRow * hRows;
        
        const total = horizontal + vertical;
        
        if (total > maxTotal) {
          maxTotal = total;
          bestCombination = {
            horizontal,
            vertical,
            horizontalConfig: { panelsPerRow: horizontalPerRow, rows: hRows },
            verticalConfig: { panelsPerRow: Math.floor(areaLength / PANEL_WIDTH), rows: vRows }
          };
        }
      }
      
      return {
        type: 'hybrid',
        total: maxTotal,
        ...bestCombination
      };
    }
    
    // 生成光伏板可视化（修复版）
    function generateVisualization(container, config, isHybrid = false) {
      container.innerHTML = '';
      
      if (!config || config.total <= 0) {
        container.innerHTML = '<div class="w-full h-full flex items-center justify-center text-gray-300 text-sm">无可用空间</div>';
        return;
      }
      
      // 关键修复：使用getBoundingClientRect()获取精确的容器尺寸
      const containerRect = container.getBoundingClientRect();
      const containerWidth = containerRect.width;
      const containerHeight = containerRect.height;
      
      // 区域实际尺寸
      const areaLength = parseFloat(lengthInput.value);
      const areaWidth = parseFloat(widthInput.value);
      
      // 计算实际排列后的尺寸
      let arrangedWidth, arrangedHeight;
      if (isHybrid) {
        // 混合排列的总高度是横排高度加上竖排高度
        const hHeight = config.horizontalConfig ? config.horizontalConfig.rows * PANEL_WIDTH : 0;
        const vHeight = config.verticalConfig ? config.verticalConfig.rows * PANEL_LENGTH : 0;
        arrangedWidth = areaLength;
        arrangedHeight = hHeight + vHeight;
      } else {
        arrangedWidth = config.panelsPerRow * config.panelLength;
        arrangedHeight = config.rows * config.panelWidth;
      }
      
      // 计算缩放比例（确保首次加载也能正确计算）
      const scaleX = containerWidth / arrangedWidth * 0.95; // 0.95 预留少量边距
      const scaleY = containerHeight / arrangedHeight * 0.95;
      const scale = Math.min(scaleX, scaleY);
      
      // 光伏板之间的间距
      const gap = 1;
      
      if (isHybrid) {
        // 混合排列可视化
        let currentY = 0;
        
        // 先绘制横排部分
        if (config.horizontalConfig && config.horizontalConfig.rows > 0) {
          const hPanelWidth = PANEL_WIDTH * scale;
          const hPanelLength = PANEL_LENGTH * scale;
          const hPanelsPerRow = config.horizontalConfig.panelsPerRow;
          
          for (let row = 0; row < config.horizontalConfig.rows; row++) {
            for (let col = 0; col < hPanelsPerRow; col++) {
              const panel = document.createElement('div');
              panel.className = 'bg-primary/20 border border-primary/40 rounded-sm transition-all hover:bg-primary/30';
              panel.style.width = `${hPanelLength}px`;
              panel.style.height = `${hPanelWidth}px`;
              panel.style.left = `${col * (hPanelLength + gap)}px`;
              panel.style.top = `${currentY}px`;
              panel.style.position = 'absolute';
              container.appendChild(panel);
            }
            currentY += hPanelWidth + gap;
          }
        }
        
        // 再绘制竖排部分
        if (config.verticalConfig && config.verticalConfig.rows > 0) {
          const vPanelWidth = PANEL_LENGTH * scale;
          const vPanelLength = PANEL_WIDTH * scale;
          const vPanelsPerRow = config.verticalConfig.panelsPerRow;
          
          for (let row = 0; row < config.verticalConfig.rows; row++) {
            for (let col = 0; col < vPanelsPerRow; col++) {
              const panel = document.createElement('div');
              panel.className = 'bg-secondary/20 border border-secondary/40 rounded-sm transition-all hover:bg-secondary/30';
              panel.style.width = `${vPanelLength}px`;
              panel.style.height = `${vPanelWidth}px`;
              panel.style.left = `${col * (vPanelLength + gap)}px`;
              panel.style.top = `${currentY}px`;
              panel.style.position = 'absolute';
              container.appendChild(panel);
            }
            currentY += vPanelWidth + gap;
          }
        }
      } else {
        // 横排或竖排可视化
        const panelWidth = config.panelWidth * scale;
        const panelLength = config.panelLength * scale;
        
        for (let row = 0; row < config.rows; row++) {
          for (let col = 0; col < config.panelsPerRow; col++) {
            const panel = document.createElement('div');
            panel.className = config.type === 'horizontal' 
              ? 'bg-primary/20 border border-primary/40 rounded-sm transition-all hover:bg-primary/30'
              : 'bg-secondary/20 border border-secondary/40 rounded-sm transition-all hover:bg-secondary/30';
            panel.style.width = `${panelLength}px`;
            panel.style.height = `${panelWidth}px`;
            panel.style.left = `${col * (panelLength + gap)}px`;
            panel.style.top = `${row * (panelWidth + gap)}px`;
            panel.style.position = 'absolute';
            container.appendChild(panel);
          }
        }
      }
    }
    
    // 创建对比图表
    function createComparisonChart(horizontal, vertical, hybrid) {
      const ctx = document.getElementById('comparisonChart').getContext('2d');
      
      // 如果图表已存在，先销毁
      if (comparisonChart) {
        comparisonChart.destroy();
      }
      
      comparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['横排方案', '竖排方案', '混合方案'],
          datasets: [{
            label: '光伏板数量',
            data: [horizontal.total, vertical.total, hybrid.total],
            backgroundColor: [
              'rgba(22, 93, 255, 0.6)',
              'rgba(54, 207, 201, 0.6)',
              'rgba(135, 102, 255, 0.6)'
            ],
            borderColor: [
              'rgba(22, 93, 255, 1)',
              'rgba(54, 207, 201, 1)',
              'rgba(135, 102, 255, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }
    
    // 计算并显示结果
    function calculateAndDisplay() {
      const areaLength = parseFloat(lengthInput.value);
      const areaWidth = parseFloat(widthInput.value);
      
      // 验证输入
      if (isNaN(areaLength) || isNaN(areaWidth) || areaLength <= 0 || areaWidth <= 0) {
        alert('请输入有效的区域尺寸');
        return;
      }
      
      // 显示结果区域（关键修复：先显示容器再计算，确保能获取正确尺寸）
      resultSection.classList.remove('hidden');
      emptyState.classList.add('hidden');
      
      // 强制重排，确保容器尺寸已计算
      void resultSection.offsetWidth;
      
      // 计算三种方案
      const horizontal = calculateHorizontal(areaLength, areaWidth);
      const vertical = calculateVertical(areaLength, areaWidth);
      const hybrid = calculateHybrid(areaLength, areaWidth);
      
      // 确定最优方案
      const maxTotal = Math.max(horizontal.total, vertical.total, hybrid.total);
      let bestMethod = '';
      
      if (maxTotal === 0) {
        alert('区域太小，无法放置任何光伏板');
        return;
      }
      
      if (maxTotal === horizontal.total && maxTotal === vertical.total && maxTotal === hybrid.total) {
        bestMethod = '横排/竖排/混合 (效果相同)';
      } else if (maxTotal === horizontal.total && maxTotal === vertical.total) {
        bestMethod = '横排/竖排 (效果相同)';
      } else if (maxTotal === horizontal.total && maxTotal === hybrid.total) {
        bestMethod = '横排/混合 (效果相同)';
      } else if (maxTotal === vertical.total && maxTotal === hybrid.total) {
        bestMethod = '竖排/混合 (效果相同)';
      } else if (maxTotal === horizontal.total) {
        bestMethod = '横排方案';
      } else if (maxTotal === vertical.total) {
        bestMethod = '竖排方案';
      } else {
        bestMethod = '混合方案';
      }
      
      // 计算空间利用率
      const areaTotal = areaLength * areaWidth;
      const panelsArea = maxTotal * PANEL_LENGTH * PANEL_WIDTH;
      const utilization = ((panelsArea / areaTotal) * 100).toFixed(1);
      
      // 更新UI显示
      bestMethodEl.textContent = bestMethod;
      maxPanelsEl.textContent = maxTotal;
      utilizationEl.textContent = `${utilization}%`;
      
      // 更新横排方案
      horizontalCountEl.textContent = horizontal.total;
      horizontalPerRowEl.textContent = horizontal.panelsPerRow;
      horizontalRowsEl.textContent = horizontal.rows;
      generateVisualization(horizontalVisualization, horizontal);
      
      // 更新竖排方案
      verticalCountEl.textContent = vertical.total;
      verticalPerRowEl.textContent = vertical.panelsPerRow;
      verticalRowsEl.textContent = vertical.rows;
      generateVisualization(verticalVisualization, vertical);
      
      // 更新混合方案
      hybridCountEl.textContent = hybrid.total;
      hybridHorizontalEl.textContent = hybrid.horizontal;
      hybridVerticalEl.textContent = hybrid.vertical;
      generateVisualization(hybridVisualization, hybrid, true);
      
      // 创建对比图表
      createComparisonChart(horizontal, vertical, hybrid);
      
      // 平滑滚动到结果区域
      resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // 事件监听
    calculateBtn.addEventListener('click', calculateAndDisplay);
    
    // 支持回车键计算
    [lengthInput, widthInput].forEach(input => {
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          calculateAndDisplay();
        }
      });
    });
    
    // 窗口大小变化时重新绘制可视化
    window.addEventListener('resize', () => {
      if (!resultSection.classList.contains('hidden')) {
        // 重新获取当前输入值
        const areaLength = parseFloat(lengthInput.value);
        const areaWidth = parseFloat(widthInput.value);
        
        if (!isNaN(areaLength) && !isNaN(areaWidth) && areaLength > 0 && areaWidth > 0) {
          // 重新计算并绘制
          const horizontal = calculateHorizontal(areaLength, areaWidth);
          const vertical = calculateVertical(areaLength, areaWidth);
          const hybrid = calculateHybrid(areaLength, areaWidth);
          
          generateVisualization(horizontalVisualization, horizontal);
          generateVisualization(verticalVisualization, vertical);
          generateVisualization(hybridVisualization, hybrid, true);
        }
      }
    });
  </script>
</body>
</html>
